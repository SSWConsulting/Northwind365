# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: CI Process

on:
  push:
    branches: [ "main", "rp-webinar" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    name: "Build & Test"

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Cache
        uses: actions/cache@v3
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup .NET SDK ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3

      - name: Restore dependencies
        run: dotnet restore

      - name: Login to Octopus Deploy 
        uses: OctopusDeploy/login@v0
        with: 
          server: https://robpearson.octopus.app
          service_account_id: 0bcc0eaa-7530-4163-9109-fc43f2dc6e53

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test --no-build --no-restore --configuration Release --logger "trx;LogFileName=TestResults.trx"

      - name: Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()    # run this step even if previous step failed
        with:
          name: Tests             # Name of the check run which will be created
          path: "**/*.trx"        # Path to test results
          reporter: dotnet-trx    # Format of test results

      # Package webapp 

      # Push to Octopus

      # Create release 

      # Deploy to Dev ?!?
